#!/usr/bin/env ruby

require 'pathname'
require 'fileutils'
include FileUtils

APP_ROOT    = Pathname.new File.expand_path('../../', __FILE__)
APP_BUNDLER = "bundler --conservative --no-document --no-force --version '~> 1.5.1'"

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

chdir APP_ROOT do
  puts '== Installing dependencies =='
  system!("gem install #{APP_BUNDLER}")
  system!('bundle check || bundle install --path vendor --binstubs bin/vendor')

  puts '== Install JavaScript dependencies if using Yarn =='
  system!('bin/yarn')

  puts '== Creating Config Files =='
  system!('cp config/cable.yml.sample config/cable.yml')
  system!('cp config/database.yml.sample config/database.yml')
  system!('cp config/secrets.yml.sample config/secrets.yml')
  %w(development test).each do |environment|
    system!(%Q{
cat .env.#{environment}.m4 | m4 \\
-D__GOVERNOR_APP_SECRET_KEY_BASE__=$(bundle exec rake secret) \\
-D__GOVERNOR_APP_DEVISE_SECRET_KEY__=$(bundle exec rake secret) \\
> .env.#{environment}})
  end

  puts '== Preparing database =='
  system!('bin/rake db:setup')

  puts '== Removing old logs and tempfiles =='
  system!('bin/rails log:clear tmp:clear')

  puts '== Restarting application server =='
  system!('bin/rails restart')
end

